{"version":3,"sources":["turbopack:///[project]/node_modules/bitcoin-backup/dist/index.js"],"sourcesContent":["// src/crypto.ts\nimport { Utils } from \"@bsv/sdk\";\nvar { toArray, toBase64 } = Utils;\nvar RECOMMENDED_PBKDF2_ITERATIONS = 600000;\nvar LEGACY_PBKDF2_ITERATIONS = 1e5;\nvar DEFAULT_PBKDF2_ITERATIONS = RECOMMENDED_PBKDF2_ITERATIONS;\nvar SALT_LENGTH_BYTES = 16;\nvar IV_LENGTH_BYTES = 12;\nvar AES_KEY_LENGTH_BITS = 256;\nasync function deriveKey(passphrase, salt, iterations = RECOMMENDED_PBKDF2_ITERATIONS) {\n  const passphraseBytes = Uint8Array.from(toArray(passphrase, \"utf8\"));\n  const keyMaterial = await globalThis.crypto.subtle.importKey(\"raw\", passphraseBytes, { name: \"PBKDF2\" }, false, [\"deriveKey\"]);\n  return globalThis.crypto.subtle.deriveKey({\n    name: \"PBKDF2\",\n    salt,\n    iterations,\n    hash: \"SHA-256\"\n  }, keyMaterial, { name: \"AES-GCM\", length: AES_KEY_LENGTH_BITS }, false, [\"encrypt\", \"decrypt\"]);\n}\nasync function encryptData(payload, passphrase, iterations) {\n  const salt = globalThis.crypto.getRandomValues(new Uint8Array(SALT_LENGTH_BYTES));\n  const iv = globalThis.crypto.getRandomValues(new Uint8Array(IV_LENGTH_BYTES));\n  const key = await deriveKey(passphrase, salt, iterations);\n  const payloadToEncrypt = {\n    ...payload,\n    createdAt: payload.createdAt || new Date().toISOString()\n  };\n  const jsonPayload = JSON.stringify(payloadToEncrypt);\n  const dataToEncrypt = new TextEncoder().encode(jsonPayload);\n  const encryptedContent = await globalThis.crypto.subtle.encrypt({ name: \"AES-GCM\", iv }, key, dataToEncrypt);\n  const combined = new Uint8Array(salt.length + iv.length + encryptedContent.byteLength);\n  combined.set(salt, 0);\n  combined.set(iv, salt.length);\n  combined.set(new Uint8Array(encryptedContent), salt.length + iv.length);\n  return toBase64(Array.from(combined));\n}\nasync function decryptData(encryptedBackup, passphrase, attemptIterations) {\n  let combinedBytesNumbers;\n  try {\n    combinedBytesNumbers = toArray(encryptedBackup, \"base64\");\n  } catch (error) {\n    console.error(\"Failed to decode base64 string (toArray threw):\", error);\n    throw new Error(\"Decryption failed: Invalid Base64 input.\");\n  }\n  if (encryptedBackup.length > 0 && combinedBytesNumbers.length === 0) {\n    throw new Error(\"Decryption failed: Invalid Base64 input (decoded to empty).\");\n  }\n  const combinedBytes = Uint8Array.from(combinedBytesNumbers);\n  if (combinedBytes.length < SALT_LENGTH_BYTES + IV_LENGTH_BYTES) {\n    throw new Error(\"Decryption failed: Encrypted data is too short.\");\n  }\n  const salt = combinedBytes.slice(0, SALT_LENGTH_BYTES);\n  const iv = combinedBytes.slice(SALT_LENGTH_BYTES, SALT_LENGTH_BYTES + IV_LENGTH_BYTES);\n  const encryptedCiphertext = combinedBytes.slice(SALT_LENGTH_BYTES + IV_LENGTH_BYTES);\n  const iterationCountsToTry = typeof attemptIterations === \"number\" ? [attemptIterations] : Array.isArray(attemptIterations) ? attemptIterations : [RECOMMENDED_PBKDF2_ITERATIONS, LEGACY_PBKDF2_ITERATIONS];\n  let lastError = null;\n  for (const iterations of iterationCountsToTry) {\n    try {\n      const key = await deriveKey(passphrase, salt, iterations);\n      const decryptedArrayBuffer = await globalThis.crypto.subtle.decrypt({ name: \"AES-GCM\", iv }, key, encryptedCiphertext);\n      const decryptedString = new TextDecoder().decode(decryptedArrayBuffer);\n      try {\n        const parsedJson = JSON.parse(decryptedString);\n        if (typeof parsedJson === \"object\" && parsedJson !== null) {\n          if (\"xprv\" in parsedJson && \"ids\" in parsedJson && \"mnemonic\" in parsedJson)\n            return parsedJson;\n          if (\"rootPk\" in parsedJson && \"ids\" in parsedJson)\n            return parsedJson;\n          if (\"wif\" in parsedJson && \"id\" in parsedJson)\n            return parsedJson;\n          if (\"ordPk\" in parsedJson && \"payPk\" in parsedJson && \"identityPk\" in parsedJson)\n            return parsedJson;\n          if (\"wif\" in parsedJson && !(\"id\" in parsedJson) && !(\"xprv\" in parsedJson) && !(\"rootPk\" in parsedJson))\n            return parsedJson;\n        }\n        throw new Error(\"Invalid backup structure after JSON parse.\");\n      } catch (jsonError) {\n        if (jsonError instanceof SyntaxError)\n          return { wif: decryptedString };\n        throw jsonError;\n      }\n    } catch (decryptionError) {\n      lastError = decryptionError;\n      if (decryptionError instanceof DOMException && decryptionError.name === \"OperationError\") {\n        continue;\n      }\n      throw decryptionError;\n    }\n  }\n  console.error(\"All decryption attempts failed. Last error:\", lastError);\n  if (lastError && lastError.name === \"OperationError\") {\n    throw new Error(\"Decryption failed: Invalid passphrase or corrupted data across all attempted iteration counts.\");\n  }\n  throw lastError || new Error(\"Decryption failed: Invalid passphrase or corrupted data across all attempted iteration counts.\");\n}\n\n// src/index.ts\nfunction isValidPayload(payload) {\n  if (!payload || typeof payload !== \"object\")\n    return false;\n  const p = payload;\n  if (\"xprv\" in p && typeof p.xprv === \"string\" && \"ids\" in p && typeof p.ids === \"string\" && \"mnemonic\" in p && typeof p.mnemonic === \"string\") {\n    return true;\n  }\n  if (\"rootPk\" in p && typeof p.rootPk === \"string\" && \"ids\" in p && typeof p.ids === \"string\" && !(\"xprv\" in p)) {\n    return true;\n  }\n  if (\"wif\" in p && typeof p.wif === \"string\" && \"id\" in p && typeof p.id === \"string\") {\n    return true;\n  }\n  if (\"wif\" in p && typeof p.wif === \"string\" && !(\"id\" in p) && !(\"xprv\" in p) && !(\"rootPk\" in p)) {\n    return true;\n  }\n  if (\"ordPk\" in p && typeof p.ordPk === \"string\" && \"payPk\" in p && typeof p.payPk === \"string\" && \"identityPk\" in p && typeof p.identityPk === \"string\") {\n    return true;\n  }\n  return false;\n}\nasync function encryptBackup(payload, passphrase, iterations) {\n  if (!isValidPayload(payload)) {\n    throw new Error(\"Invalid payload: Payload must be an object matching BapMasterBackup, BapMemberBackup, WifBackup, or OneSatBackup structure.\");\n  }\n  if (typeof passphrase !== \"string\" || passphrase.length === 0) {\n    throw new Error(\"Invalid passphrase: Passphrase must be a non-empty string.\");\n  }\n  if (passphrase.length < 8) {\n    throw new Error(\"Invalid passphrase: Passphrase must be at least 8 characters long.\");\n  }\n  return encryptData(payload, passphrase, iterations);\n}\nasync function decryptBackup(encryptedString, passphrase, attemptIterations) {\n  if (typeof encryptedString !== \"string\" || encryptedString.length === 0) {\n    throw new Error(\"Invalid encryptedString: Must be a non-empty string.\");\n  }\n  if (typeof passphrase !== \"string\" || passphrase.length === 0) {\n    throw new Error(\"Invalid passphrase: Passphrase must be a non-empty string.\");\n  }\n  return decryptData(encryptedString, passphrase, attemptIterations);\n}\nexport {\n  encryptBackup,\n  decryptBackup,\n  RECOMMENDED_PBKDF2_ITERATIONS,\n  LEGACY_PBKDF2_ITERATIONS,\n  DEFAULT_PBKDF2_ITERATIONS\n};\n"],"names":[],"mappings":"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","ignoreList":[0]}